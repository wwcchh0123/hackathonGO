# XGopilot Desktop 架构设计文档

## 项目概述

XGopilot Desktop 是一个基于 **Electron + React + MUI** 构建的智能桌面助手，用户可以通过语音和文字与 AI 进行自然交互，让 AI 帮助完成各种计算机任务。它封装了 Claude Code CLI，提供了友好的图形界面、会话管理、实时流式输出等增强功能。

XGopilot Desktop 还提供安全隔离的虚拟桌面（VNC）环境，通过 Docker 容器技术运行独立的 Ubuntu 桌面系统，让 AI 能够安全地操作浏览器、编辑器、终端等图形化应用程序。这个虚拟环境完全隔离于宿主机，所有操作都在沙箱中执行，既保证了系统安全，又赋予了 AI 强大的计算机操作能力（Computer Use）。

### 主要功能

- **流式对话**：实时流式显示 Claude 的响应和工具调用
- **会话管理**：创建、切换、删除多个对话会话，自动持久化
- **虚拟桌面**：集成 VNC 容器，支持计算机操作（Computer Use）
- **语音输入**：集成科大讯飞语音识别服务
- **自定义配置**：工作目录、环境变量、自定义 System Prompt
- **任务控制**：随时终止正在执行的任务

## 核心原理

### 执行流程架构图

```
┌──────────────────────────────────────────────────────────────────┐
│                         用户层                                    │
│              ┌────────────────────────────┐                       │
│              │   XGopilot Desktop App     │                       │
│              │  (Electron + React + MUI)  │                       │
│              │                            │                       │
│              │  • 语音/文字输入           │                       │
│              │  • 会话管理                │                       │
│              │  • 流式输出显示            │                       │
│              │  • VNC 面板控制            │                       │
│              └────────────┬───────────────┘                       │
└───────────────────────────┼──────────────────────────────────────┘
                            │
                            │ IPC 通信
                            │ (spawn + stream)
                            ▼
┌──────────────────────────────────────────────────────────────────┐
│                    AI 智能引擎层                                  │
│              ┌────────────────────────────┐                       │
│              │     Claude Code CLI        │                       │
│              │                            │                       │
│              │  • 接收 System Prompt      │                       │
│              │  • 理解用户意图            │                       │
│              │  • 规划执行步骤            │                       │
│              │  • 调用 MCP 工具           │                       │
│              │  • 流式返回结果            │                       │
│              └────────────┬───────────────┘                       │
└───────────────────────────┼──────────────────────────────────────┘
                            │
                            │ MCP 协议
                            │ (Model Context Protocol)
                            ▼
┌──────────────────────────────────────────────────────────────────┐
│                    工具执行层 (MCP Servers)                       │
│                                                                   │
│  ┌─────────────────────┐          ┌──────────────────────┐       │
│  │   本机环境 (Host)   │          │  虚拟桌面 (VNC)      │       │
│  │                     │          │                      │       │
│  │  • 文件读写 (Read)  │          │  • 浏览器操作        │       │
│  │  • 文件编辑 (Edit)  │          │  • 鼠标点击          │       │
│  │  • 命令执行 (Bash)  │          │  • 键盘输入          │       │
│  │  • 文件搜索 (Glob)  │          │  • 截图识别          │       │
│  │  • 内容搜索 (Grep)  │          │  • 应用程序控制      │       │
│  │  • Web 获取         │          │  • (Docker 隔离)     │       │
│  └─────────────────────┘          └──────────────────────┘       │
│           ▲                                    ▲                  │
│           │                                    │                  │
│           └──────────── 执行反馈 ──────────────┘                  │
│                    (stdout/stderr)                                │
└──────────────────────────────────────────────────────────────────┘

执行流程说明：
1. 用户输入消息（语音或文字） → Desktop App
2. App 构建 System Prompt → 调用 Claude Code CLI
3. Claude 分析任务 → 选择合适的 MCP 工具
4. 工具在本机或 VNC 环境中执行
5. 执行结果流式返回 → 实时显示在 UI
```

## 关键技术细节

#### 数据流向

当用户发送消息时，完整的数据流如下：

```
用户输入消息
    ↓
ChatInput → ChatPage.handleSendMessage()
    ↓
PromptBuilder.build() 生成完整 System Prompt
    ↓
window.api.sendMessage({
  command: 'claude',
  baseArgs: ['--output-format', 'stream-json', ...],
  message: '用户消息',
  systemPrompt: '<完整 Prompt>',
  sessionId: 'request-uuid'
})
    ↓
Electron 主进程 IPC Handler
    ├─ 创建 ClaudeJsonStreamProcessor
    ├─ spawn('claude', [...args])
    ├─ 监听 stdout 流
    └─ processChunk(chunk)
         ├─ 逐行分割缓冲
         ├─ JSON.parse(line)
         ├─ 根据消息类型分类处理
         └─ sendStreamUpdate(sessionId, {type, data})
    ↓
IPC 事件: 'claude-stream'
    ↓
App.tsx handleStreamEvent()
    ├─ requestToChatSessionMap 查询目标会话 ID
    ├─ 根据 stage 分类:
    │  ├─ 'response' → 助手文本消息
    │  ├─ 'tool' → 工具调用信息
    │  └─ 'warning' → 警告消息
    ├─ addMessage() 添加到消息列表
    └─ updateSessionMessages() 持久化
    ↓
UI 自动更新（React 响应式渲染）
```

#### Prompt 构建逻辑

#### 三层构建

```
┌──────────────────────────────────────┐
│  Layer 1: BASE_SYSTEM_PROMPT         │  (基础能力声明)
│  ├─ 工具使用指南 (Read/Write/Bash)   │
│  ├─ 安全和最佳实践                   │
│  └─ 角色定位                         │
├──────────────────────────────────────┤
│  Layer 2: COMPUTER_USE_PROMPT        │  (VNC 启用时)
│  ├─ VNC 桌面操作指南                 │
│  ├─ 端口配置信息                     │
│  └─ 系统架构说明                     │
├──────────────────────────────────────┤
│  Layer 3: 动态信息                   │
│  ├─ 当前日期                         │
│  ├─ 工作目录                         │
│  ├─ 自定义指令 (用户配置)            │
│  └─ VNC 状态                         │
└──────────────────────────────────────┘
```

#### 关键 MCP 工具

项目集成了两类 MCP 服务器，分别对应本机环境和 VNC 虚拟桌面环境。另外，有需要的时候，还可以自行添加 MCP 工具。

**本机环境工具（Host MCP）**：

| 工具         | 功能     | 说明                      |
| ------------ | -------- | ------------------------- |
| **Read**     | 文件读取 | 读取本机文件内容          |
| **Write**    | 文件写入 | 创建或覆写文件            |
| **Edit**     | 文件编辑 | 精确替换文件中的指定内容  |
| **Bash**     | 命令执行 | 执行 shell 命令，获取输出 |
| **Glob**     | 文件搜索 | 使用 glob 模式搜索文件    |
| **Grep**     | 内容搜索 | 在文件中搜索文本内容      |
| **WebFetch** | Web 获取 | 获取网页内容并解析        |

**VNC 虚拟桌面工具（VNC MCP）**：

| 工具                 | 功能       | 说明                                  |
| -------------------- | ---------- | ------------------------------------- |
| **vnc_screenshot**   | 桌面截图   | 获取 VNC 桌面截图供 Claude 分析       |
| **vnc_click**        | 鼠标点击   | 在指定坐标点击鼠标                    |
| **vnc_mouse_move**   | 鼠标移动   | 移动鼠标到指定位置                    |
| **vnc_type**         | 键盘输入   | 输入文本内容                          |
| **vnc_key**          | 按键操作   | 按下特定按键（Enter、Tab、Ctrl+C 等） |
| **vnc_drag**         | 拖拽操作   | 拖拽元素到目标位置                    |
| **browser_navigate** | 浏览器导航 | 打开指定 URL                          |
| **browser_click**    | 浏览器点击 | 点击网页元素                          |
| **browser_snapshot** | 页面快照   | 获取页面可访问性快照                  |

**工作原理**：

1. **System Prompt 声明**：在 System Prompt 中声明可用的 MCP 工具及其用法
2. **Claude 决策**：Claude 根据用户意图选择合适的工具
3. **工具调用**：通过 MCP 协议调用对应的工具
4. **结果返回**：工具执行结果返回给 Claude
5. **流式反馈**：执行过程和结果实时显示在 UI
