# 桌面应用打包指南

本文档介绍如何将 Claude Code Desktop 打包为各平台的安装包。

## 📋 前置要求

### 所有平台

- Node.js >= 16
- npm 或 pnpm
- 已安装项目依赖 (`npm install`)

### macOS 打包

- macOS 操作系统（推荐 macOS 10.13 或更高）
- Xcode Command Line Tools

### Windows 打包

- Windows 10 或更高版本
- 或在 macOS/Linux 上使用 Wine 进行交叉编译

### Linux 打包

- Linux 操作系统
- 或在 macOS/Windows 上使用 Docker 进行交叉编译

## 🚀 快速开始

### 1. 安装依赖

```bash
npm install
```

### 2. 生成图标（首次打包时需要）

```bash
# 生成所有平台图标
npm run icons:all
```

### 3. 打包应用

```bash
# 打包当前平台的应用
npm run dist

# 或者指定平台
npm run dist:mac      # macOS
npm run dist:win      # Windows
npm run dist:linux    # Linux
```

## 📦 打包命令详解

### `npm run pack`

**用途**: 快速打包测试（不创建安装包）

- 仅打包应用文件，不生成安装程序
- 输出目录: `release/[platform]-unpacked/`
- 适合快速测试打包结果

```bash
npm run pack
```

### `npm run dist`

**用途**: 生成完整的安装包（当前平台）

- 自动构建 Web 资源
- 生成对应平台的安装包
- 输出目录: `release/`

```bash
npm run dist
```

### 平台特定打包命令

```bash
# macOS 打包（生成 .dmg 和 .zip）
npm run dist:mac

# Windows 打包（生成 .exe 安装程序和 .zip）
npm run dist:win

# Linux 打包（生成 .AppImage, .deb, .rpm）
npm run dist:linux
```

## 📂 输出文件说明

打包完成后，所有输出文件位于 `release/` 目录：

### macOS

```
release/
├── Agent for Desktop-0.1.0-arm64.dmg    # Apple Silicon 安装镜像
├── Agent for Desktop-0.1.0-x64.dmg     # Intel 芯片安装镜像
├── Agent for Desktop-0.1.0-arm64-mac.zip
└── Agent for Desktop-0.1.0-x64-mac.zip
```

### Windows

```
release/
├── Agent for Desktop Setup 0.1.0.exe   # NSIS 安装程序
└── Agent for Desktop-0.1.0-win.zip     # 便携版
```

### Linux

```
release/
├── Agent-for-Desktop-0.1.0.AppImage   # 通用格式
├── agent-for-desktop_0.1.0_amd64.deb  # Debian/Ubuntu
└── agent-for-desktop-0.1.0.x86_64.rpm # RedHat/Fedora
```

## ⚙️ 打包配置

打包配置位于 `package.json` 的 `build` 字段：

```json
{
  "build": {
    "appId": "com.qiniu.claude-code-desktop",
    "productName": "Agent for Desktop",
    "directories": {
      "output": "release"
    }
  }
}
```

### 关键配置项说明

| 配置项 | 说明 |
|--------|------|
| `appId` | 应用唯一标识符（macOS Bundle ID, Windows App User Model ID） |
| `productName` | 应用显示名称 |
| `directories.output` | 打包输出目录 |
| `files` | 需要打包的文件列表 |
| `mac.category` | macOS 应用分类 |
| `mac.target` | macOS 打包格式（dmg, zip） |
| `win.target` | Windows 打包格式（nsis, zip） |
| `linux.target` | Linux 打包格式（AppImage, deb, rpm） |

## 🎨 图标管理

### 图标文件位置

```
assets/icons/
├── icon.svg          # 源图标（SVG 格式）
├── icon.png          # 通用图标（512x512）
├── icon-16.png       # 各种尺寸的 PNG
├── icon-32.png
├── icon-48.png
├── icon-128.png
├── icon-256.png
├── icon-512.png
├── icon.icns         # macOS 图标
└── icon.ico          # Windows 图标
```

### 生成图标

```bash
# 从 SVG 生成各种尺寸的 PNG
npm run icons

# 生成平台特定图标（.icns, .ico）
npm run icons:platform

# 一次性生成所有图标
npm run icons:all
```

### 自定义图标

1. 替换 `assets/icons/icon.svg` 为你的图标文件
2. 运行 `npm run icons:all` 重新生成所有图标

**图标要求**:
- SVG 格式，正方形（1:1 比例）
- 建议尺寸: 512x512 或更大
- 简洁设计，在小尺寸下清晰可见

## 🔐 代码签名（可选）

### macOS 代码签名

1. 加入 Apple Developer Program
2. 创建开发者证书
3. 配置环境变量:

```bash
export CSC_LINK="path/to/certificate.p12"
export CSC_KEY_PASSWORD="certificate_password"
```

4. 打包时自动签名:

```bash
npm run dist:mac
```

### Windows 代码签名

1. 获取代码签名证书（从 CA 购买）
2. 配置环境变量:

```bash
export WIN_CSC_LINK="path/to/certificate.pfx"
export WIN_CSC_KEY_PASSWORD="certificate_password"
```

3. 打包时自动签名:

```bash
npm run dist:win
```

## 🐛 常见问题

### 1. 图标未正确显示

**解决方案**:
```bash
# 重新生成所有图标
npm run icons:all

# 清除缓存后重新打包
rm -rf release dist
npm run dist
```

### 2. macOS 提示"应用已损坏"

**原因**: 应用未签名

**解决方案**:
```bash
# 临时解决（开发测试）
xattr -cr "/Applications/Agent for Desktop.app"

# 永久解决：配置代码签名
```

### 3. Windows Defender 报毒

**原因**: 应用未签名，Windows 对未签名应用会警告

**解决方案**:
- 开发测试：添加到 Windows Defender 白名单
- 正式发布：购买代码签名证书并签名

### 4. Linux 打包失败

**解决方案**:
```bash
# 安装必要的依赖
sudo apt-get install fakeroot dpkg rpm
```

### 5. 打包文件过大

**检查原因**:
```bash
# 查看打包文件列表
npm run pack
```

**优化建议**:
- 检查 `package.json` 中的 `files` 配置
- 确保 `node_modules` 只包含生产依赖
- 移除不必要的资源文件

## 📝 完整打包流程示例

```bash
# 1. 确保依赖已安装
npm install

# 2. 生成所有图标（首次打包）
npm run icons:all

# 3. 运行测试
npm run test

# 4. 构建 Web 资源
npm run build

# 5. 打包应用
npm run dist:mac  # 根据你的平台选择

# 6. 测试打包结果
open release/  # 打开输出目录
```

## 🚢 发布流程

### 1. 更新版本号

```bash
# 编辑 package.json 中的 version 字段
# 例如: "version": "0.2.0"
```

### 2. 打包所有平台（如果可用）

```bash
npm run dist:mac
npm run dist:win
npm run dist:linux
```

### 3. 测试安装包

在各个平台上测试安装包是否正常工作

### 4. 创建 GitHub Release

```bash
git tag v0.2.0
git push origin v0.2.0
```

上传打包文件到 GitHub Release

### 5. 编写发布说明

包括：
- 新功能
- 修复的问题
- 已知问题
- 升级注意事项

## 📚 更多资源

- [electron-builder 官方文档](https://www.electron.build/)
- [Electron 打包指南](https://www.electronjs.org/docs/latest/tutorial/application-distribution)
- [代码签名指南](https://www.electron.build/code-signing)

## 💡 提示

- 首次打包可能需要下载依赖，时间较长，请耐心等待
- 打包前确保运行 `npm run build` 构建最新的 Web 资源
- 使用 `npm run pack` 快速测试，避免每次都生成完整安装包
- 发布前务必在目标平台上测试安装包
- macOS 和 Windows 应用建议进行代码签名，提升用户信任度
