<!DOCTYPE html>
<html>
<head>
    <title>useStream Hook æµ‹è¯•</title>
    <style>
        body {
            font-family: monospace;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .container {
            border: 1px solid #444;
            padding: 20px;
            border-radius: 5px;
        }
        h2 {
            color: #4fc3f7;
        }
        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .user {
            background: #264653;
            text-align: right;
        }
        .assistant {
            background: #2a9d8f;
        }
        .stream {
            background: #e76f51;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .controls {
            margin: 20px 0;
        }
        button {
            background: #4fc3f7;
            color: black;
            border: none;
            padding: 10px 20px;
            margin: 0 5px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background: #29b6f6;
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        input {
            padding: 10px;
            width: 100%;
            box-sizing: border-box;
            background: #2c2c2c;
            color: white;
            border: 1px solid #444;
            border-radius: 5px;
            margin: 10px 0;
        }
        .stats {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .error {
            background: #d32f2f;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>ğŸ§ª useStream Hook æ‰‹åŠ¨æµ‹è¯•</h2>
        
        <div class="stats">
            <strong>çŠ¶æ€ï¼š</strong>
            <span id="status">ç©ºé—²</span> |
            <strong>æ¶ˆæ¯æ•°ï¼š</strong>
            <span id="messageCount">0</span> |
            <strong>æµæ–‡æœ¬ï¼š</strong>
            <span id="streamText"></span>
        </div>

        <div class="controls">
            <input type="text" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." value="Hello Claude">
            <button id="startBtn">å¼€å§‹æµ</button>
            <button id="pauseBtn" disabled>æš‚åœ</button>
            <button id="resumeBtn" disabled>æ¢å¤</button>
            <button id="abortBtn" disabled>ä¸­æ­¢</button>
            <button id="clearBtn">æ¸…ç©º</button>
        </div>

        <div id="error" class="error" style="display: none;"></div>
        
        <div id="messages"></div>
    </div>

    <script>
        // æ¨¡æ‹Ÿ useStream Hook çš„è¡Œä¸º
        class StreamSimulator {
            constructor() {
                this.messages = [];
                this.currentStream = null;
                this.isStreaming = false;
                this.isPaused = false;
                this.error = null;
                this.listeners = {};
            }

            startStream(message, options = {}) {
                console.log('ğŸ“¤ startStream:', message, options);
                
                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
                this.messages.push({
                    id: Date.now() + '-user',
                    role: 'user',
                    content: message,
                    timestamp: Date.now()
                });
                
                // å¼€å§‹æµ
                this.isStreaming = true;
                this.currentStream = {
                    id: Date.now() + '-stream',
                    chunks: [],
                    startTime: Date.now()
                };
                
                this.emit('update');
                
                // æ¨¡æ‹Ÿæµå¼å“åº”
                this.simulateStream();
                
                return this.currentStream.id;
            }
            
            simulateStream() {
                const responses = [
                    { type: 'message_start', id: 'msg_123' },
                    { type: 'delta', delta: { text: 'I' } },
                    { type: 'delta', delta: { text: ' am' } },
                    { type: 'delta', delta: { text: ' a' } },
                    { type: 'delta', delta: { text: ' simulated' } },
                    { type: 'delta', delta: { text: ' stream' } },
                    { type: 'delta', delta: { text: ' response' } },
                    { type: 'delta', delta: { text: '!' } },
                    { type: 'complete' }
                ];
                
                let index = 0;
                const interval = setInterval(() => {
                    if (!this.isStreaming || index >= responses.length) {
                        clearInterval(interval);
                        this.endStream();
                        return;
                    }
                    
                    if (!this.isPaused) {
                        const chunk = responses[index];
                        this.handleChunk(chunk);
                        index++;
                    }
                }, 200);
                
                this.intervalId = interval;
            }
            
            handleChunk(chunk) {
                if (this.currentStream) {
                    this.currentStream.chunks.push(chunk);
                    this.emit('update');
                }
            }
            
            endStream() {
                if (this.currentStream) {
                    const text = this.getAccumulatedText();
                    if (text) {
                        this.messages.push({
                            id: this.currentStream.id + '-assistant',
                            role: 'assistant',
                            content: text,
                            timestamp: this.currentStream.startTime
                        });
                    }
                }
                
                this.isStreaming = false;
                this.isPaused = false;
                this.currentStream = null;
                this.emit('update');
            }
            
            pauseStream() {
                this.isPaused = true;
                this.emit('update');
            }
            
            resumeStream() {
                this.isPaused = false;
                this.emit('update');
            }
            
            abortStream() {
                if (this.intervalId) {
                    clearInterval(this.intervalId);
                }
                this.isStreaming = false;
                this.isPaused = false;
                this.currentStream = null;
                this.emit('update');
            }
            
            clearMessages() {
                this.messages = [];
                this.error = null;
                this.emit('update');
            }
            
            getAccumulatedText() {
                if (!this.currentStream) return '';
                return this.currentStream.chunks
                    .filter(c => c.type === 'delta' && c.delta?.text)
                    .map(c => c.delta.text)
                    .join('');
            }
            
            on(event, callback) {
                if (!this.listeners[event]) {
                    this.listeners[event] = [];
                }
                this.listeners[event].push(callback);
            }
            
            emit(event, data) {
                if (this.listeners[event]) {
                    this.listeners[event].forEach(cb => cb(data));
                }
            }
        }
        
        // åˆå§‹åŒ–
        const stream = new StreamSimulator();
        
        // UI æ›´æ–°
        function updateUI() {
            // çŠ¶æ€
            let status = 'ç©ºé—²';
            if (stream.isStreaming) {
                status = stream.isPaused ? 'å·²æš‚åœ' : 'æµå¼ä¼ è¾“ä¸­...';
            }
            document.getElementById('status').textContent = status;
            
            // æ¶ˆæ¯æ•°
            document.getElementById('messageCount').textContent = stream.messages.length;
            
            // æµæ–‡æœ¬
            document.getElementById('streamText').textContent = stream.getAccumulatedText() || '(æ— )';
            
            // æ¶ˆæ¯åˆ—è¡¨
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = stream.messages.map(msg => `
                <div class="message ${msg.role}">
                    <strong>${msg.role === 'user' ? 'ğŸ‘¤ ç”¨æˆ·' : 'ğŸ¤– åŠ©æ‰‹'}:</strong> ${msg.content}
                </div>
            `).join('');
            
            // å½“å‰æµ
            if (stream.currentStream) {
                messagesDiv.innerHTML += `
                    <div class="message stream">
                        <strong>ğŸ”„ æµå¼å“åº”:</strong> ${stream.getAccumulatedText()}<span style="animation: pulse 0.5s infinite;">â–Š</span>
                    </div>
                `;
            }
            
            // æŒ‰é’®çŠ¶æ€
            document.getElementById('startBtn').disabled = stream.isStreaming;
            document.getElementById('pauseBtn').disabled = !stream.isStreaming || stream.isPaused;
            document.getElementById('resumeBtn').disabled = !stream.isStreaming || !stream.isPaused;
            document.getElementById('abortBtn').disabled = !stream.isStreaming;
        }
        
        // ç›‘å¬æ›´æ–°
        stream.on('update', updateUI);
        
        // ç»‘å®šæŒ‰é’®
        document.getElementById('startBtn').onclick = () => {
            const message = document.getElementById('messageInput').value;
            if (message) {
                stream.startStream(message);
                document.getElementById('messageInput').value = '';
            }
        };
        
        document.getElementById('pauseBtn').onclick = () => stream.pauseStream();
        document.getElementById('resumeBtn').onclick = () => stream.resumeStream();
        document.getElementById('abortBtn').onclick = () => stream.abortStream();
        document.getElementById('clearBtn').onclick = () => stream.clearMessages();
        
        // å›è½¦å‘é€
        document.getElementById('messageInput').onkeypress = (e) => {
            if (e.key === 'Enter' && !stream.isStreaming) {
                document.getElementById('startBtn').click();
            }
        };
        
        // åˆå§‹æ›´æ–°
        updateUI();
        
        console.log('âœ¨ useStream Hook æ¨¡æ‹Ÿå™¨å·²å°±ç»ª');
        console.log('ğŸ“ åœ¨æ§åˆ¶å°å¯ä»¥è®¿é—® stream å¯¹è±¡è¿›è¡Œè°ƒè¯•');
    </script>
</body>
</html>